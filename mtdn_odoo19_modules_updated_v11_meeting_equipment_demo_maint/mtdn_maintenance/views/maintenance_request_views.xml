<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Kanban -->
    <record id="view_mtdn_maintenance_request_kanban" model="ir.ui.view">
        <field name="name">mtdn.maintenance.request.kanban</field>
        <field name="model">mtdn.maintenance.request</field>
        <field name="arch" type="xml">
            <!-- Easier overview: default columns by state -->
            <kanban class="o_kanban_small_column" default_group_by="state">
                <field name="name"/>
                <field name="request_for"/>
                <field name="room_id"/>
                <field name="asset_id"/>
                <field name="category_id"/>
                <field name="priority"/>
                <field name="start_datetime"/>
                <field name="end_datetime"/>
                <field name="is_active_downtime"/>
                <field name="state"/>
                <templates>
                    <t t-name="card">
                        <div t-attf-class="o_kanban_record mtdn_kanban_card mtdn_state_{{ record.state.raw_value }}">
                            <div class="mtdn_kanban_title">
                                <div class="fw-bold"><field name="name"/></div>
                                <div>
                                    <field name="state" widget="badge"
                                           decoration-info="state == 'draft'"
                                           decoration-warning="state in ('submitted','in_progress')"
                                           decoration-success="state == 'done'"
                                           decoration-danger="state == 'cancelled'"/>
                                </div>
                            </div>

                            <div class="mt8">
                                <field name="request_for" widget="badge"/>
                                <t t-if="record.priority.raw_value">
                                    <span class="ms-1"><field name="priority" widget="badge"
                                        decoration-info="priority == '0'"
                                        decoration-warning="priority == '1'"
                                        decoration-danger="priority in ('2','3')"/></span>
                                </t>
                                <t t-if="record.is_active_downtime.raw_value">
                                    <span class="badge text-bg-danger ms-1">DOWNTIME</span>
                                </t>
                            </div>

                            <div class="mtdn_kanban_meta_line mt8">
                                <span class="mtdn_kanban_label">Đối tượng:</span>
                                <t t-if="record.request_for.raw_value == 'room'"><field name="room_id"/></t>
                                <t t-elif="record.request_for.raw_value == 'asset'"><field name="asset_id"/></t>
                            </div>

                            <div class="mtdn_kanban_meta_line mt4">
                                <span class="mtdn_kanban_label">Hạng mục:</span>
                                <span><field name="category_id"/></span>
                            </div>

                            <div class="mtdn_kanban_meta_line mt4">
                                <span class="mtdn_kanban_label">Thời gian:</span>
                                <span><field name="start_datetime"/> - <field name="end_datetime"/></span>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- List -->
    <record id="view_mtdn_maintenance_request_list" model="ir.ui.view">
        <field name="name">mtdn.maintenance.request.list</field>
        <field name="model">mtdn.maintenance.request</field>
        <field name="arch" type="xml">
            <list string="Phiếu bảo trì">
                <field name="name"/>
                <field name="request_for" widget="badge"/>
                <field name="room_id" invisible="request_for != 'room'"/>
                <field name="asset_id" invisible="request_for != 'asset'"/>
                <field name="category_id"/>
                <field name="priority" widget="badge"
                       decoration-info="priority == '0'"
                       decoration-warning="priority == '1'"
                       decoration-danger="priority in ('2','3')"/>
                <field name="start_datetime"/>
                <field name="end_datetime"/>
                <field name="assigned_user_id"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-warning="state in ('submitted','in_progress')"
                       decoration-success="state == 'done'"
                       decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>

    <!-- Form -->
    <record id="view_mtdn_maintenance_request_form" model="ir.ui.view">
        <field name="name">mtdn.maintenance.request.form</field>
        <field name="model">mtdn.maintenance.request</field>
        <field name="arch" type="xml">
            <form string="Phiếu bảo trì">
                <header>
                    <button name="action_set_draft" type="object" string="Đưa về nháp"
                            class="btn-secondary"
                            invisible="state not in ('submitted','in_progress')"/>
                    <button name="action_submit" type="object" string="Gửi phiếu"
                            class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_start" type="object" string="Bắt đầu xử lý"
                            class="btn-primary"
                            invisible="state != 'submitted'"/>
                    <button name="action_done" type="object" string="Hoàn tất"
                            class="btn-success"
                            invisible="state != 'in_progress'"/>
                    <button name="action_cancel" type="object" string="Hủy"
                            class="btn-danger"
                            invisible="state == 'cancelled' or state == 'done'"/>
                    <field name="state" widget="statusbar" options="{'clickable': False}"/>
                </header>

                <sheet>
                    <widget name="web_ribbon" title="DOWNTIME" bg_color="bg-danger" invisible="not is_active_downtime"/>
                    <widget name="web_ribbon" title="ƯU TIÊN CAO" bg_color="bg-warning" invisible="priority not in ('2','3')"/>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>

                    <group>
                        <group>
                            <field name="request_for"/>
                            <field name="room_id" invisible="request_for != 'room'" required="request_for == 'room'" domain="[('company_id','=',company_id)]"/>
                            <field name="asset_id" invisible="request_for != 'asset'" required="request_for == 'asset'" domain="[('company_id','=',company_id)]"/>
                            <field name="category_id"/>
                            <field name="priority"/>
                        </group>
                        <group>
                            <field name="request_date" readonly="1"/>
                            <field name="requested_by" readonly="1"/>
                            <field name="team_id"/>
                            <field name="assigned_user_id"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Downtime">
                            <group>
                                <field name="start_datetime"/>
                                <field name="end_datetime"/>
                                <field name="is_active_downtime" readonly="1"/>
                            </group>
                            <group>
                                <field name="description" placeholder="Mô tả sự cố / yêu cầu..."/>
                            </group>
                        </page>

	                        <page string="Xử lý &amp; Chi phí">
                            <group>
                                <field name="resolution" placeholder="Kết quả xử lý..."/>
                            </group>
                            <group>
                                <field name="cost"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Search -->
    <record id="view_mtdn_maintenance_request_search" model="ir.ui.view">
        <field name="name">mtdn.maintenance.request.search</field>
        <field name="model">mtdn.maintenance.request</field>
        <field name="arch" type="xml">
	            <search string="Tìm phiếu bảo trì">
	                <field name="name"/>
	                <field name="request_for"/>
	                <field name="room_id"/>
	                <field name="asset_id"/>
	                <field name="category_id"/>
	                <field name="team_id"/>
	                <field name="state"/>
	                <separator/>
	                <filter string="Đang xử lý" name="in_progress" domain="[('state','=','in_progress')]"/>
	                <filter string="Đang downtime" name="active_downtime" domain="[('state','in',('submitted','in_progress')),('start_datetime','!=',False),('end_datetime','!=',False)]"/>
	            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_mtdn_maintenance_request" model="ir.actions.act_window">
        <field name="name">Phiếu bảo trì</field>
        <field name="res_model">mtdn.maintenance.request</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="view_mtdn_maintenance_request_search"/>
        <field name="context">{}</field>
    </record>
</odoo>
